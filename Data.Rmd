---
title: "Data preparation"
#bibliography: references.bib
author: "Niels Vullings"
bibliography: references.bib
---

```{=html}
<style>
body {
  text-align: justify;
  font-family: Times;
}

h1, .h1, h2, .h2, h3, .h3 {
  margin-top: 24px;
  font-family: Times;
}
</style>
```
```{r, globalsettings, echo=FALSE, warning=FALSE, results='hide'}
library(knitr)

knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test2"))
options(width = 100)
rgl::setupKnitr()



colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x) }

```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
# klippy::klippy(color = 'darkgreen')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```

Last compiled on `r format(Sys.time(), '%B, %Y')`

<br>

------------------------------------------------------------------------

# Set up

```{r, warning=FALSE}
rm(list = ls())

# Libraries
library(tidyverse)  # I assume you already installed this one!
library(igraph)


```

# Load data

```{r}
load("data/processed/soc_data_raw.RData")

load("data/processed/RU_UU_ego.RData")

load("data/processed/RU_UU_works.RData")

```

<br>

------------------------------------------------------------------------

# Data

This study uses collaboration data of sociologists from the Radboud University and Utrecht University, which has been scraped from the internet. It is part of a larger data project aiming to create large scale social network data on the collaborations of Dutch university scholars in the field of Political Science and Sociology. The data collection process is threefold. First, all employees of Sociology and Political Science departments at all Dutch universities were collected, filing their names, university, department, position and Google Scholar id code. This data was collected for both 2022 and 2024. Second, the works of all these authors were scraped through OpenAlex, a nonprofit database on open science (ref.). Lastly, this raw data was subset to get the sample relevant for this study. I ended up with sample of 100 sociologists from Radboud University (n = 44, 39) and Utrecht University (n = 48, 44). More information about the process and source code can be found under the "Data Manipulation" folder on this website.\
  Before I explain the creation of the networks, it is important to note that the initial data collection in 2022 and 2024 does not determine the waves. The waves are determined based on the parameters set by the researcher. For this study, I analysed publication between 2015 to 2019 (wave 1) and 2020 to 2024 (wave 2). The implication this has for the data as a whole will be elaborated on in the discussion. Based on these waves, collaboration networks were created by analysing whether or not two scholars in the sample have worked together on a publication in each given wave. These networks are directed, which means the first author who sends a tie to all coauthors. This means that an actor with many indegrees often coauthors with different people, while an actor with a lot of outdegrees looks for many others to collaborate with. I chose this network structure, because it ???

## Covariates

The main independent variable of this study is gender. As gender was not available in the OpenAlex data, I developed a webscraped that determines the extent to which a name is considered to be female. Using Rvest, I scrape the first name of each author in the dataset. This results in a score from 0 to 1, where 0 means there are no women in the Netherlands with that name, while 1 means there are no men with that name. This is a scale variable, meaning technically means that an author can be 80% female. This was done to add some variability to this measure, as this way of constructing gender is a matter of association rather than an actual measure of how someone identifies themselves.\
  To measure academic prestige, I added two variables: the number of Q1 journals in each wave and an author's H-index. The number of Q1 journals is a varying covariate, which means it can change over time. The rank of each journal was taken from Scimago, a public repository for worldwide journal and institution rankings (ref). Their measure (SJR best quartile) is determined by the number of weighted citations of the works that were published in the journal in the last three years (ref.). This standardized measure ensures that larger journals do not skew the overall ranking. I then summed the number of Q1 publications for each author, regardless of their position on the paper. The author's H-index was scraped from OpenAlex by Lucan Bovens. It measures the prestige of an author, by calculating how many papers have been cited at least as many times as their total amount of publication and can be expressed as the following formula: $$H_{index} = \sum_{N_c=>N_p}^{n}x_n$$ (***I have no clue if this is correct or makes sense... HELP***). It will be used as a stable covariate, as the H-index does not significantly change over the waves.

  To control for several

# Descriptive Analysis

## Scholars per university

```{r}

df_ego %>% count(Universiteit1.22)
df_ego %>% count(Universiteit2.22)


df_ego %>% count(Universiteit1.24)
df_ego %>% count(Universiteit2.24)

```

## Functions

```{r}
df_ego %>% group_by(Universiteit1.22) %>% count(Functie.22)

df_ego %>% group_by(Universiteit1.24) %>% count(Functie.24)
```

## Gender

### Gender distribution per University in 22 and 24

```{r}

df_ego %>% group_by(Universiteit1.22) %>% 
  summarise(mean_gender = mean(perc_female, na.rm = TRUE))


df_ego %>% group_by(Universiteit1.24) %>% 
  summarise(mean_gender = mean(perc_female, na.rm = TRUE))

```

### Gender distribution per University and per Function in 22 and 24

!!Important to change function levels to have more meaningful results!!

```{r}
df_ego %>% group_by(Universiteit1.22, Functie.22) %>% 
  summarise(mean_gender = mean(perc_female, na.rm = TRUE))

df_ego %>% group_by(Universiteit1.24, Functie.24) %>% 
  summarise(mean_gender = mean(perc_female, na.rm = TRUE))
```

### TO ADD!!

-   Prestigious publications per university/gender/time

-   Moran's I for network segregation in terms of gender

    -   For 22 and 24 to see how/if networks change

-   Other statistics

    -   Nice descriptives table

    -   Network statistics table (density, betweeness, transitivity etc.)

## Networks

### Make the graph object

```{r}

#---- Wave 2 ----
graph_w1 <- igraph::graph_from_adjacency_matrix(
  soc_data$nets[1,,], #now, I take the second wave
  mode = c("directed"),
  weighted = NULL,
  diag = FALSE,
  add.colnames = NULL
)

#---- Wave 2 ----
graph_w2 <- igraph::graph_from_adjacency_matrix(
  soc_data$nets[2,,], #now, I take the second wave
  mode = c("directed"),
  weighted = NULL,
  diag = FALSE,
  add.colnames = NULL
)

```

### Network Visualisations (Universities)

#### Wave 1 {.tabset}

##### University Colours

```{r, fig.width = 8}

#---- Wave 1 ----
set.seed(234544)
l_w1 <- layout_nicely(graph_w1)

plot(graph_w1, layout = l_w1,
     vertex.color = ifelse(df_ego$Universiteit1.22 == "RU", "red", "gold"), #now, I can use actor attributes for plotting. 
     vertex.label = NA,
     edge.width = 1.8,
     edge.arrow.size =0.5,
     main = "Network of Radboud and Utrecht University Sociologists")
legend("topleft", c("Radboud", "Utrecht University"), pch = c(21,21), col = "#777777", pt.bg = c("red", "gold"), pt.cex = 2,
       cex = 0.8, bty = "n", ncol = 1)

```

##### Better contrast

```{r, fig.width = 8}

#---- Wave 1 ----
set.seed(234544)
l_w1 <- layout_nicely(graph_w1)

plot(graph_w1, layout = l_w1,
     vertex.color = ifelse(df_ego$Universiteit1.22 == "RU", "navy", "darkorange"), #now, I can use actor attributes for plotting. 
     vertex.label = NA,
     edge.width = 1.8,
     edge.arrow.size =0.5,
     main = "Network of Radboud and Utrecht University Sociologists")
legend("topleft", c("Radboud", "Utrecht University"), pch = c(21,21), col = "#777777", pt.bg = c("navy", "darkorange"), pt.cex = 2,
       cex = 0.8, bty = "n", ncol = 1)

```

#### Wave 2 {.tabset}

##### University Colours

```{r, fig.width = 8}
#---- Wave 2 ----
set.seed(234544)
l_w2 <- layout_nicely(graph_w2)

plot(graph_w2, layout = l_w2,
     vertex.color = ifelse(df_ego$Universiteit1.24 == "RU", "red", "gold"), #now, I can use actor attributes for plotting. 
     vertex.label = NA,
     edge.width = 1.8,
     edge.arrow.size = 0.5,
     main = "Network of Radboud and Utrecht University Sociologists")
legend("topleft", c("Radboud", "Utrecht University"), pch = c(21,21), col = "#777777", pt.bg = c("red", "gold"), pt.cex = 2,
       cex = 0.8, bty = "n", ncol = 1)

```

##### Better Contrast

```{r, fig.width = 8}
#---- Wave 2 ----
set.seed(234544)
l_w2 <- layout_nicely(graph_w2)

plot(graph_w2, layout = l_w2,
     vertex.color = ifelse(df_ego$Universiteit1.24 == "RU", "navy", "darkorange"), #now, I can use actor attributes for plotting. 
     vertex.label = NA,
     edge.width = 1.8,
     edge.arrow.size = 0.5,
     main = "Network of Radboud and Utrecht University Sociologists")
legend("topleft", c("Radboud", "Utrecht University"), pch = c(21,21), col = "#777777", pt.bg = c("navy", "darkorange"), pt.cex = 2,
       cex = 0.8, bty = "n", ncol = 1)

```

### Network Visualisations (Gender)

```{r}
# Make a plotable gender variable to fix problems with vertex.shape
df_ego <- df_ego %>% mutate(plot_gen = case_when(perc_female >= 0.80 ~ "Female",
                                                 .default = "Male"))
# df_ego %>% count(plot_gen)
```

#### Wave 1 {.tabset}

##### University Colours

```{r, fig.width = 8}

#---- Wave 1 ----
set.seed(234544)
l_w1 <- layout_nicely(graph_w1)

plot(graph_w1, layout = l_w1,
     vertex.color = ifelse(df_ego$Universiteit1.24 == "RU", "red", "gold"), #now, I can use actor attributes for plotting. 
     vertex.shape = ifelse(df_ego$plot_gen == "Male", "square", "circle"),
     vertex.label = NA,
     edge.width = 2,
     edge.curved = 0.5,
     edge.arrow.size =0.2,
     main = "Gender Distribution of Two Sociology Departments 2022")
legend("topleft", c("Radboud", "Utrecht University", "Male", "Female"), pch = c(21,21,15,20), col = "#777777", pt.bg = c("red", "gold"), pt.cex = 2,
       cex = 0.8, bty = "n", ncol = 1)
```

##### Better Contrast

```{r, fig.width = 8}

#---- Wave 1 ----
set.seed(234544)
l_w1 <- layout_nicely(graph_w1)

plot(graph_w1, layout = l_w1,
     vertex.color = ifelse(df_ego$Universiteit1.24 == "RU", "navy", "darkorange"), #now, I can use actor attributes for plotting. 
     vertex.shape = ifelse(df_ego$plot_gen == "Male", "square", "circle"),
     vertex.label = NA,
     edge.width = 2,
     edge.curved = 0.5,
     edge.arrow.size =0.2,
     main = "Gender Distribution of Two Sociology Departments 2022")
legend("topleft", c("Radboud", "Utrecht University", "Male", "Female"), pch = c(21,21,15,20), col = "#777777", pt.bg = c("navy", "darkorange"), pt.cex = 2,
       cex = 0.8, bty = "n", ncol = 1)
```

#### Wave 2 {.tabset}

##### University Colours

```{r, fig.width = 8}
#---- Wave 2 ----
set.seed(234544)
l_w2 <- layout_nicely(graph_w2)

plot(graph_w2, layout = l_w2,
     vertex.color = ifelse(df_ego$Universiteit1.24 == "RU", "red", "gold"), #now, I can use actor attributes for plotting. 
     vertex.shape = ifelse(df_ego$plot_gen == "Male", "square", "circle"),
     vertex.label = NA,
     edge.width = 2,
     edge.curved = 0.5,
     edge.arrow.size =0.2,
     main = "Gender Distribution of Two Sociology Departments 2022")
legend("topleft", c("Radboud", "Utrecht University", "Male", "Female"), pch = c(21,21,15,20), col = "#777777", pt.bg = c("red", "gold"), pt.cex = 2,
       cex = 0.8, bty = "n", ncol = 1)

```

##### Better Contrast

```{r, fig.width = 8}
#---- Wave 2 ----
set.seed(234544)
l_w2 <- layout_nicely(graph_w2)

plot(graph_w2, layout = l_w2,
     vertex.color = ifelse(df_ego$Universiteit1.24 == "RU", "navy", "darkorange"), #now, I can use actor attributes for plotting. 
     vertex.shape = ifelse(df_ego$plot_gen == "Male", "square", "circle"),
     vertex.label = NA,
     edge.width = 2,
     edge.curved = 0.5,
     edge.arrow.size =0.2,
     main = "Gender Distribution of Two Sociology Departments 2022")
legend("topleft", c("Radboud", "Utrecht University", "Male", "Female"), pch = c(21,21,15,20), col = "#777777", pt.bg = c("navy", "darkorange"), pt.cex = 2,
       cex = 0.8, bty = "n", ncol = 1)

```

<br>

------------------------------------------------------------------------
